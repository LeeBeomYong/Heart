<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.heartpet.action.NoticeDAO">
	<!-- <select id="notice_list" resultType="com.heartpet.model.NoticeDTO">
		select * from heartpet_notice where notice_status = 1 order by notice_no desc
	</select>	 -->
	
	<sql id="notice_keyword">
		LIKE '%' || #{keyword} || '%'
    </sql>
	
	<select id="notice_content" parameterType="int" resultType="com.heartpet.model.NoticeDTO">
		select * from heartpet_notice where notice_no = #{no}
	</select>	
	
	<update id="notice_read" parameterType="int">
		update heartpet_notice set notice_hit = (notice_hit + 1) where notice_no = #{no}
	</update>
	
	<insert id="notice_insert" parameterType="com.heartpet.model.NoticeDTO">
		<selectKey resultType="int" keyProperty="notice_no" order="BEFORE">
			select max(notice_no) from heartpet_notice
		</selectKey>
			insert into heartpet_notice values(#{notice_no}+1,#{notice_title},#{notice_content},#{notice_hit},#{notice_img1},#{notice_img2},sysdate)
	</insert>
	
	<update id="notice_update" parameterType="com.heartpet.model.NoticeDTO">
		update heartpet_notice set notice_title=#{notice_title}, notice_content=#{notice_content}, notice_hit=#{notice_hit}, notice_img1=#{notice_img1}, notice_img2=#{notice_img2}, notice_date = sysdate where notice_no = #{notice_no} 
	</update>
	
	<update id="notice_delete" parameterType="int">
		update heartpet_notice set notice_status = 0 where notice_no = #{no}
	</update>
	
  	<select id="notice_list" parameterType="hashMap" resultType="com.heartpet.model.NoticeDTO">
				
		SELECT * 
		FROM (SELECT s.*, row_number() over(order by notice_no desc) rnum from heartpet_notice s 
		WHERE notice_status = 1
		<choose>
			<when test="field.equals('allSearch') and keyword != ''">and (notice_title <include refid="notice_keyword" />) OR (notice_content <include refid="notice_keyword" />) and notice_status = 1</when>
			<when test="field.equals('title') and keyword != ''">and notice_title <include refid="notice_keyword" /> and notice_status = 1</when>
			<when test="field.equals('cont') and keyword != ''">and notice_content <include refid="notice_keyword" /> and notice_status = 1</when>
		</choose>
		<![CDATA[) WHERE rnum >= #{startNo} and rnum <= #{endNo}]]>
		
	</select>
	
 	<select id="notice_count" parameterType="hashMap" resultType="int">
		select count(*) from heartpet_notice where notice_status=1
		<choose>
			<when test="field.equals('allSearch') and keyword != ''">and (notice_title <include refid="notice_keyword" />) OR (notice_content <include refid="notice_keyword" />) and notice_status = 1</when>
			<when test="field.equals('title') and keyword != ''">and notice_title <include refid="notice_keyword" /> and notice_status = 1</when>
			<when test="field.equals('cont') and keyword != ''">and notice_content <include refid="notice_keyword" /> and notice_status = 1</when>
		</choose>
	</select> 
</mapper>